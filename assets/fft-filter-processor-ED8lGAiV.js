function P(e,t){const s=e.length;if(s!=t.length)throw new RangeError("Mismatched lengths");s!=0&&(s&s-1?z(e,t):_(e,t))}function g(e,t){P(t,e)}function _(e,t){const s=e.length;if(s!=t.length)throw new RangeError("Mismatched lengths");if(s==1)return;let h=-1;for(let r=0;r<32;r++)1<<r==s&&(h=r);if(h==-1)throw new RangeError("Length is not a power of 2");const i=new Array(s/2),l=new Array(s/2);for(let r=0;r<s/2;r++)i[r]=Math.cos(2*Math.PI*r/s),l[r]=Math.sin(2*Math.PI*r/s);for(let r=0;r<s;r++){const a=o(r,h);if(a>r){let c=e[r];e[r]=e[a],e[a]=c,c=t[r],t[r]=t[a],t[a]=c}}for(let r=2;r<=s;r*=2){const a=r/2,c=s/r;for(let u=0;u<s;u+=r)for(let M=u,n=0;M<u+a;M++,n+=c){const d=M+a,I=e[d]*i[n]+t[d]*l[n],m=-e[d]*l[n]+t[d]*i[n];e[d]=e[M]-I,t[d]=t[M]-m,e[M]+=I,t[M]+=m}}function o(r,a){let c=0;for(let u=0;u<a;u++)c=c<<1|r&1,r>>>=1;return c}}function z(e,t){const s=e.length;if(s!=t.length)throw new RangeError("Mismatched lengths");let h=1;for(;h<s*2+1;)h*=2;const i=new Array(s),l=new Array(s);for(let n=0;n<s;n++){const d=n*n%(s*2);i[n]=Math.cos(Math.PI*d/s),l[n]=Math.sin(Math.PI*d/s)}const o=w(h),r=w(h);for(let n=0;n<s;n++)o[n]=e[n]*i[n]+t[n]*l[n],r[n]=-e[n]*l[n]+t[n]*i[n];const a=w(h),c=w(h);a[0]=i[0],c[0]=l[0];for(let n=1;n<s;n++)a[n]=a[h-n]=i[n],c[n]=c[h-n]=l[n];const u=new Array(h),M=new Array(h);v(o,r,a,c,u,M);for(let n=0;n<s;n++)e[n]=u[n]*i[n]+M[n]*l[n],t[n]=-u[n]*l[n]+M[n]*i[n]}function v(e,t,s,h,i,l){const o=e.length;if(o!=t.length||o!=s.length||o!=h.length||o!=i.length||o!=l.length)throw new RangeError("Mismatched lengths");e=e.slice(),t=t.slice(),s=s.slice(),h=h.slice(),P(e,t),P(s,h);for(let r=0;r<o;r++){const a=e[r]*s[r]-t[r]*h[r];t[r]=t[r]*s[r]+e[r]*h[r],e[r]=a}g(e,t);for(let r=0;r<o;r++)i[r]=e[r]/o,l[r]=t[r]/o}function w(e){const t=[];for(let s=0;s<e;s++)t.push(0);return t}const y=e=>Math.sin(Math.PI*e)/(Math.PI*e),b=e=>{const t=Math.abs(e);if(t<3.75){const s=e/3.75*(e/3.75);return 1+s*(3.5156229+s*(3.0899424+s*(1.2067492+s*(.2659732+s*(.0360768+s*.0045813)))))}else{const s=3.75/t;return Math.exp(t)/Math.sqrt(t)*(.39894228+s*(.01328592+s*(.00225319+s*(-.00157565+s*(.00916281+s*(-.02057706+s*(.02635537+s*(-.01647633+s*.00392377))))))))}},A={hann:(e,t)=>.5-.5*Math.cos(2*Math.PI*e/(t-1)),hamming:(e,t)=>.54-.46*Math.cos(2*Math.PI*e/(t-1)),cosine:(e,t)=>Math.sin(Math.PI*e/(t-1)),lanczos:(e,t)=>y(2*e/(t-1)-1),gaussian:(e,t,s=.4)=>Math.pow(Math.E,-.5*Math.pow((e-(t-1)/2)/(s*(t-1)/2),2)),tukey:(e,t,s=.5)=>e<.5*s*(t-1)?.5*(1+Math.cos(Math.PI*(2*e/(s*(t-1))-1))):e<(1-.5*s)*(t-1)?1:.5*(1+Math.cos(Math.PI*(2*e/(s*(t-1))+1-2/s))),blackman:(e,t)=>.42-.5*Math.cos(2*Math.PI*e/(t-1))+.08*Math.cos(4*Math.PI*e/(t-1)),exact_blackman:(e,t)=>.4243801-.4973406*Math.cos(2*Math.PI*e/(t-1))+.0782793*Math.cos(4*Math.PI*e/(t-1)),kaiser:(e,t,s=3)=>b(Math.PI*s*Math.sqrt(1-Math.pow(2*e/(t-1)-1,2)))/b(Math.PI*s),nuttall:(e,t)=>.355768-.487396*Math.cos(2*Math.PI*e/(t-1))+.144232*Math.cos(4*Math.PI*e/(t-1))-.012604*Math.cos(6*Math.PI*e/(t-1)),blackman_harris:(e,t)=>.35875-.48829*Math.cos(2*Math.PI*e/(t-1))+.14128*Math.cos(4*Math.PI*e/(t-1))-.01168*Math.cos(6*Math.PI*e/(t-1)),blackman_nuttall:(e,t)=>.3635819-.3635819*Math.cos(2*Math.PI*e/(t-1))+.1365995*Math.cos(4*Math.PI*e/(t-1))-.0106411*Math.cos(6*Math.PI*e/(t-1)),flat_top:(e,t)=>1-1.93*Math.cos(2*Math.PI*e/(t-1))+1.29*Math.cos(4*Math.PI*e/(t-1))-.388*Math.cos(6*Math.PI*e/(t-1))+.032*Math.cos(8*Math.PI*e/(t-1))},E=(e,t,s)=>{const h=e.length;for(let i=0;i<h;++i)e[i]*=t(i,h,s);return e},k=e=>(t,s)=>E(t,A[e],s),C=k("hann");class p{maxSize;loop;data;size;toProduce;toConsume;constructor(t,s=!1){if(!Number.isInteger(t)||t<1)throw new Error("Invalid parameter");this.maxSize=t,this.loop=s,this.data=new Array(t),this.clear()}push(t){if(this.size>=this.maxSize){if(!this.loop)throw new Error("Queue overflow");this.pop()}this.data[this.toProduce]=t,++this.toProduce>=this.maxSize&&(this.toProduce=0),++this.size}pop(){if(this.size<=0)throw new Error("Queue empty");const t=this.data[this.toConsume];return++this.toConsume>=this.maxSize&&(this.toConsume=0),--this.size,t}top(){if(!(this.size<=0))return this.data[this.toConsume]}getSize(){return this.size}isEmpty(){return this.size<=0}clear(){this.size=this.toProduce=this.toConsume=0}[Symbol.iterator](){const t=this.maxSize,s=this.data;let h=this.size,i=this.toConsume;return{next(){if(h<=0)return{done:!0,value:null};const l=s[i];return++i>=t&&(i=0),--h,{done:!1,value:l}}}}}const f=2048;class F extends AudioWorkletProcessor{audible_ranges=[];real=new Float64Array(f);imag=new Float64Array(f).fill(0);last_iteration=new Float64Array(f/2).fill(0);prev_time=0;buff=new p(5*f,!0);ready=new p(5*f,!0);constructor(){super(),this.port.onmessage=t=>{const s=t.data;s.audible_ranges&&(this.audible_ranges=s.audible_ranges)}}process(t,s,h){const i=t[0][0],l=i.length;for(let o=0;o<l;o++)this.buff.push(i[o]);for(;this.buff.getSize()>=f;){for(let o=0;o<f/2;o++)this.real[o]=this.buff.pop(),this.imag[o]=0;{let o=0;for(const r of this.buff)if(this.real[f/2+o]=r,this.imag[f/2+o]=0,++o>=f/2)break}C(this.real),P(this.real,this.imag);for(let o=0;o<f;o++){const r=o*sampleRate/f;let a=this.audible_ranges.length===0;for(const c of this.audible_ranges)if(r>=c.start&&r<=c.end){a=!0;break}a||(this.real[o]=this.imag[o]=0)}currentTime-this.prev_time>1/60&&(this.port.postMessage({real:this.real.subarray(0,f/2),imag:this.imag.subarray(0,f/2)}),this.prev_time=currentTime),g(this.real,this.imag);for(let o=0;o<f/2;o++){const r=this.last_iteration[o]+this.real[o]/f;this.ready.push(r)}for(let o=0;o<f/2;o++)this.last_iteration[o]=this.real[f/2+o]/f}for(let o=0;o<l;o++)for(let r=0;r<s.length;r++){const a=this.ready.isEmpty()?0:this.ready.pop();for(let c=0;c<s[r].length;c++)s[r][c][o]=a}return!1}}registerProcessor("fft-filter",F);
